---
title: "CIMIS"
output: github_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo=F, message=F, warning=F}
# read CIMIS data via the public API and plot results
## 
## http://et.water.ca.gov/Rest/Index
  
# stuff you need
#
#   1) a CIMIS API key (see http://et.water.ca.gov/Home/Faq)
#   2) write the key to disk in json format:
#        {
#        "CIMIS-API-KEY": "b7aaaaff-zzzz-yyyy-xxxx-4ab4bbbb1b8"
#        }
#   3) adjust the startDate, endDate, and station per your requirements
  
library(jsonlite)
library(gridExtra)
library(cowplot)

if (FALSE) {
  cimisKey <- fromJSON("./PRIVATE-CIMIS-API-KEY.json")
  baseURL <- "http://et.water.ca.gov/api/data?appKey="
  key <- cimisKey[["CIMIS-API-KEY"]] 
  station <- "&targets=231"
  start <- "&startDate=2018-01-01"
  end <- "&endDate=2018-08-30"
  #end <- paste("&endDate=", Sys.Date(), sep="")
  units <- "&unitOfMeasure=M"
  # units <- "&unitOfMeasure=E"   # default = english units
  
  apiString <- paste(baseURL, key, station, start, end, units, sep="")
  print(apiString)
  
  data <- fromJSON(apiString)   # CIMIS appears to be throttling requests.....
  data.df <- as.data.frame(data)
  df2.df <- as.data.frame(data.df$Data.Providers.Records)
  
  
  write.csv(jsonlite::flatten(df2.df), './weather/CIMIS231.csv')
  
} else {    # read data saved to disc to avoid
            # multiple hits to the CIMIS db
  
  df2.df <- read.csv("./weather/CIMIS231.csv")
  
}
  

#
# CIMIS data items : http://et.water.ca.gov/Rest/Index
# 

df2.df$DayAirTmpAvg <- as.numeric(df2.df$DayAirTmpAvg.Value)
df2.df$DayAirTmpMin <- as.numeric(df2.df$DayAirTmpMin.Value)
df2.df$DayAirTmpMax <- as.numeric(df2.df$DayAirTmpMax.Value)
df2.df$DaySoilTmpAvg <- as.numeric(df2.df$DaySoilTmpAvg.Value)
df2.df$DayRelHumAvg <- as.numeric(df2.df$DayRelHumAvg.Value)
df2.df$DayWindSpdAvg <- as.numeric(df2.df$DayWindSpdAvg.Value)
df2.df$Julian <- as.numeric(df2.df$Julian)

# convert more vars as necessary
  
```

```{r, echo=F, message=F, warning=F}
library(ggplot2)

ambient231 <- ggplot(data = df2.df, aes(x=Julian)) + 
  geom_line(aes(y = DayAirTmpMax), colour = "red") +
  geom_line(aes(y = DayAirTmpAvg), colour = "green") +
  geom_line(aes(y = DayAirTmpMin), colour = "blue") +
  ylim(-10,40) +
  scale_y_continuous(breaks=seq(-10,40,10), 
                       sec.axis = sec_axis(~.*(9/5) + 32,
                                           breaks= seq(0, 110, 10),
                                           name= "air temp (F)"))  +
  labs(title = paste("Ambient Temperatures", sep=""), 
      subtitle = paste("CIMIS station #231", sep=""),
      y = "air temp (C)") +
  theme_bw() +
  theme(axis.title.y.right = element_text(angle = 90))
  
humidity231 <- ggplot(data = df2.df, aes(x=Julian, y=DayRelHumAvg)) + 
  # geom_line(aes(y = DayRelHumAvg), colour = "blue") +
  geom_point(shape=21) + 
  geom_smooth(method="lm", level=0.95) +  
  geom_vline(xintercept=175) +
  # ylim(-10,40) +
  scale_y_continuous(breaks=seq(0,100,10))  +
  labs(y = "average relative humidity (%)") +
  labs(title= paste("Average Relative Humidity", sep=""), 
         subtitle = paste("CIMIS station #231", sep="")) +
  annotate("segment", x = 120, xend = 175, y = 60, yend = 70,
  colour = "blue") +
  theme_bw() +
  annotate("text", x = 100, y = 60, label = "spray stylet oil")

ground231 <- ggplot(data = df2.df, aes(x=Julian, y=DaySoilTmpAvg)) + 
  geom_point(shape=21) + 
  geom_smooth(method="lm", level=0.95) +  
  geom_vline(xintercept=175) +
  ylim(0,40) +
  expand_limits(y = 40) +
  # scale_y_continuous(breaks=seq(0,40,10),
  scale_y_continuous(
    sec.axis = sec_axis(~.*(9/5) + 32,
                        breaks= seq(0, 110, 10),
                        name= "temp (F)")) +
  labs(x = "julian", y = "temp (C)") +
  labs(title = paste("Average Soil Temperature", sep=""), 
        subtitle = paste("CIMIS station #231", sep=""),
        caption=paste("sensor located 15 cm (6 in) below soil surface", 
                     "\n under irrigated grass", sep="") )  +
  theme_bw() +
  theme(axis.title.y.right = element_text(angle = 90)) 

wind231 <- ggplot(data = df2.df, aes(x=Julian, y=DayWindSpdAvg)) + 
  geom_point(shape=21) + 
  geom_smooth(method="lm", level=0.95) +  

  ylim(0,10) +
  expand_limits(y = 10) +
  # scale_y_continuous(breaks=seq(0,40,10),
  scale_y_continuous(
    sec.axis = sec_axis(~.*(9/5) + 32,
                        breaks= seq(0, 10, 1),
                        name= "meters/second")) +
  labs(x = "julian", y = "meters/second") +
  labs(title = paste("Average Wind Speed", sep=""), 
        subtitle = paste("CIMIS station #231", sep=""),
        caption=paste("", sep="") )  +
  theme_bw() +
  theme(axis.title.y.right = element_text(angle = 90)) 

```


```{r, echo=T, message=F, warning=F}


ampelos.ambient <- plot_grid(ambient231,
                             
            label_size=12, 
            label_fontface = "plain",
            axis="t",
            align = "v",
            ncol = 1,
            #rel_heights = c(1),      # applies to rows
            rel_widths = c(1),    # applies to columns
            scale = c(1)
          )

  # it is difficult to adjust the space between plots with plot_grid()
  # https://github.com/wilkelab/cowplot/issues/31
  # 
  
  print(ampelos.ambient)
  
  ampelos.ground <- plot_grid(ground231,
                             
            label_size=12, 
            label_fontface = "plain",
            axis="t",
            align = "v",
            ncol = 1,
            #rel_heights = c(1),      # applies to rows
            rel_widths = c(1),    # applies to columns
            scale = c(1)
          )

  # it is difficult to adjust the space between plots with plot_grid()
  # https://github.com/wilkelab/cowplot/issues/31
  # 
  
  print(ampelos.ground)
  
  
  
  
  ampelos.humidity <- plot_grid(humidity231,

            axis="t",
            align = "v",
            ncol = 1,
            #rel_heights = c(1),      # applies to rows
            rel_widths = c(1),    # applies to columns
            scale = c(1)
          )
  
  print(ampelos.humidity)
  
  ampelos.wind <- plot_grid(wind231,
          
            axis="t",
            align = "v",
            ncol = 1,
            #rel_heights = c(1),      # applies to rows
            rel_widths = c(1),    # applies to columns
            scale = c(1)
          )
  
  print(ampelos.wind)

```

