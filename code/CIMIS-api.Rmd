---
title: "CIMIS"
output: github_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# read CIMIS data via the public API and plot results
## 
## http://et.water.ca.gov/Rest/Index
  
# stuff you need
#
#   1) a CIMIS API key (see http://et.water.ca.gov/Home/Faq)
#   2) write the key to disk in json format:
#        {
#        "CIMIS-API-KEY": "b7aaaaff-zzzz-yyyy-xxxx-4ab4bbbb1b8"
#        }
#   3) adjust the startDate, endDate, and station per your requirements
  
library(jsonlite)

cimisKey <- fromJSON("./PRIVATE-CIMIS-API-KEY.json")
baseURL <- "http://et.water.ca.gov/api/data?appKey="
key <- cimisKey[["CIMIS-API-KEY"]]
station <- "&targets=231"
start <- "&startDate=2018-01-01"
end <- paste("&endDate=", Sys.Date(), sep="")
units <- "&unitOfMeasure=M"
# units <- "&unitOfMeasure=E"   # default = english units
apiString <- paste(baseURL, key, station, start, end, units, sep="")
data <- fromJSON(apiString)   # CIMIS appears to be throttling requests.....
data.df <- as.data.frame(data)
df2.df <- as.data.frame(data.df$Data.Providers.Records)
  

#
# CIMIS data items : http://et.water.ca.gov/Rest/Index
# 

# convert df values to numeric
# 

DayAirTmpAvg.list <- df2.df$DayAirTmpAvg$Value       # save the values
df2.df$DayAirTmpAvg <- NULL                          # delete the column (currently a df)
df2.df$DayAirTmpAvg <- as.numeric(DayAirTmpAvg.list) # re-create the column as numeric

DayAirTmpMin.list <- df2.df$DayAirTmpMin$Value       
df2.df$DayAirTmpMin <- NULL                        
df2.df$DayAirTmpMin <- as.numeric(DayAirTmpMin.list)
  
DayAirTmpMax.list <- df2.df$DayAirTmpMax$Value       
df2.df$DayAirTmpMax <- NULL                        
df2.df$DayAirTmpMax <- as.numeric(DayAirTmpMax.list)

DaySoilTmpAvg.list <- df2.df$DaySoilTmpAvg$Value       
df2.df$DaySoilTmpAvg <- NULL                        
df2.df$DaySoilTmpAvg <- as.numeric(DaySoilTmpAvg.list)

DayRelHumAvg.list <- df2.df$DayRelHumAvg$Value       
df2.df$DayRelHumAvg <- NULL                        
df2.df$DayRelHumAvg <- as.numeric(DayRelHumAvg.list)
  
Julian.list <- df2.df$Julian       
df2.df$Julian <- NULL                        
df2.df$Julian <- as.numeric(Julian.list)
  
# convert more vars as necessary
  
```

```{r}
library(ggplot2)

ggplot(data = df2.df, aes(x=Julian)) + 
  geom_line(aes(y = DayAirTmpMax), colour = "red") +
  geom_line(aes(y = DayAirTmpAvg), colour = "green") +
  geom_line(aes(y = DayAirTmpMin), colour = "blue") +
  ylim(-10,40) +
  scale_y_continuous(breaks=seq(-10,40,10), 
                       sec.axis = sec_axis(~.*(9/5) + 32,
                                           breaks= seq(0, 110, 10),
                                           name= "air temp (F)"))  +
  labs(y = "air temp (C)") +
  theme(axis.title.y.right = element_text(angle = 90))
  
ggplot(data = df2.df, aes(x=Julian, y=DayRelHumAvg)) + 
  # geom_line(aes(y = DayRelHumAvg), colour = "blue") +
  geom_point(shape=21) + 
  geom_smooth(method="lm", level=0.95) +  
  geom_vline(xintercept=175) +
  # ylim(-10,40) +
  scale_y_continuous(breaks=seq(0,100,10))  +
  labs(y = "average relative humidity (%)") +
  labs(title= paste("Average Relative Humidity", sep=""), 
         subtitle = paste("CIMIS station #231", sep="")) +
  annotate("segment", x = 120, xend = 175, y = 60, yend = 70,
  colour = "blue") +
  annotate("text", x = 100, y = 60, label = "spray stylet oil")

ggplot(data = df2.df, aes(x=Julian, y=DaySoilTmpAvg)) + 
  geom_point(shape=21) + 
  geom_smooth(method="lm", level=0.95) +  
  geom_vline(xintercept=175) +
  ylim(0,40) +
  expand_limits(y = 40) +
  # scale_y_continuous(breaks=seq(0,40,10),
  scale_y_continuous(
    sec.axis = sec_axis(~.*(9/5) + 32,
                        breaks= seq(0, 110, 10),
                        name= "temp (F)")) +
  labs(x = "julian", y = "temp (C)") +
  labs(title = paste("Average Soil Temperature", sep=""), 
        subtitle = paste("CIMIS station #231", sep=""),
        caption=paste("sensor located 15 cm (6 in) below soil surface", 
                     "\n under irrigated grass", sep="") )  +
  theme(axis.title.y.right = element_text(angle = 90)) 

```
