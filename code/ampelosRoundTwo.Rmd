---
title: "ampelos V2"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

densityFacets <- function(tibble, periodString) {
  
  gg <- ggplot(data = tibble, # add the data
       aes(x = positionX / 3.281, y = Thomisidae..crab.spider.,
           color = transect)) +   
    geom_jitter() +
    facet_grid(~transect) +
    #scale_x_continuous(breaks = seq(0, 200, 1)) +
    
    labs(title = paste("thomisidae observations seasonal ",
                        periodString, sep=""),
       x = "trap distance from field edge (m)", 
       y = "count") +
  
    scale_y_continuous(breaks = seq(0, 4, 1)) +
    theme_bw() +
  
    theme(legend.position="none") +
  
    scale_colour_hue(name="transect",    # Legend label, use darker colors
                  breaks=c("SNH", "control"),
                  labels=c("SNH", "control"),
                  l=40)             # Use darker colors, lightness=40
  
  return(gg)
  
}

densityNoFacets <- function(tibble, periodString) {
  
  gg <- ggplot(data = tibble, # add the data
       aes(x = transect, y = Thomisidae..crab.spider., # set x, y coordinates
           color = transect)) +    # color by treatment
    geom_jitter() +
    
    labs(title = paste("thomisidae observations seasonal ",
                        periodString, sep=""),
       x = "transect", 
       y = "counts") +
    
    scale_y_continuous(breaks = seq(0, 4, 1)) +
  
    theme_bw() +
  
    theme(legend.position="none") 
  
  return(gg)
}


errorBars <- function(tibble, periodString, observations) {
  
  # http://www.cookbook-r.com/Graphs/Plotting_means_and_error_bars_(ggplot2)/

  # The errorbars overlapped, so use position_dodge to move them horizontally
  pd <- position_dodge(1.5) # move them .05 to the left and right

  gg <- ggplot(tibble, aes(x=positionX / 3.281, y=mean, colour=transect, group=transect)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), colour="black", width=.1, position=pd) +
    geom_line(position=pd) +
    geom_point(position=pd, size=3, shape=21, fill="white") + # 21 is filled circle
  
    labs(title = paste("mean thomisidae collection rate: seasonal ",
                        periodString, sep=""),
       subtitle = "(daylight)",
       caption = paste(observations, 
                       " observations\n at each trap position", sep=""),
       x = "trap distance from field edge (m)", 
       y = "mean rate +/- SE (count / 8 hrs)") +
  
    scale_colour_hue(name="transect",    # Legend label, use darker colors
                     breaks=c("oakMargin", "control"),
                     labels=c("SNH", "control"),
                     l=40) +            # Use darker colors, lightness=40

    expand_limits(y=0) +                        # Expand y range
    scale_y_continuous() +
    scale_x_continuous(breaks = seq(0, 60, 20)) +
  
    theme_bw() 
  
  return(gg)
  
}

```



```{r effects}

library(tidyr)
library(dplyr)
library(ggplot2)

# "weeks 23-25",  "weeks 26-30", "weeks 31-34"

source.url <- c("https://raw.githubusercontent.com/cordphelps/ampelos/master/data/bugs.csv")


bugs.tibl <- as_tibble(read.csv(source.url, header=TRUE, row.names=NULL))


thomisidae.period1.oakMargin.tibl <- bugs.tibl %>% 
  filter(time != 'am') %>%
  filter(transect == 'oakMargin') %>%
  filter(week < 26) %>%
  group_by(position) %>%
    summarize(mean = mean(Thomisidae..crab.spider., na.rm=TRUE))

thomisidae.period1.control.tibl <- bugs.tibl %>% 
  filter(time != 'am') %>%
  filter(transect == 'control') %>%
  filter(week < 26) %>%
  group_by(position) %>%
    summarize(mean = mean(Thomisidae..crab.spider., na.rm=TRUE))

thomisidae.period2.oakMargin.tibl <- bugs.tibl %>% 
  filter(time != 'am') %>%
  filter(transect == 'oakMargin') %>%
  filter(week > 25 & week < 31) %>%
  group_by(position) %>%
    summarize(mean = mean(Thomisidae..crab.spider., na.rm=TRUE))

thomisidae.period2.control.tibl <- bugs.tibl %>% 
  filter(time != 'am') %>%
  filter(transect == 'control') %>%
  filter(week > 25 & week < 31) %>%
  group_by(position) %>%
    summarize(mean = mean(Thomisidae..crab.spider., na.rm=TRUE))

thomisidae.period3.oakMargin.tibl <- bugs.tibl %>% 
  filter(time != 'am') %>%
  filter(transect == 'oakMargin') %>%
  filter(week > 30) %>%
  group_by(position) %>%
    summarize(mean = mean(Thomisidae..crab.spider., na.rm=TRUE))

thomisidae.period3.control.tibl <- bugs.tibl %>% 
  filter(time != 'am') %>%
  filter(transect == 'control') %>%
  filter(week > 30) %>%
  group_by(position) %>%
    summarize(mean = mean(Thomisidae..crab.spider., na.rm=TRUE))

library(JGmisc)

JGmisc::cohens.d(thomisidae.period1.oakMargin.tibl$mean, thomisidae.period1.control.tibl$mean)

JGmisc::cohens.d(thomisidae.period2.oakMargin.tibl$mean, thomisidae.period2.control.tibl$mean)

JGmisc::cohens.d(thomisidae.period3.oakMargin.tibl$mean, thomisidae.period3.control.tibl$mean)

# effect size, early season: d = 0.757   ('large' Cohen 1988)
# effect size, mid season:   d = 0.0348  ('very small' Sawilowsky, 2009)
# effect size, late season:  d = 0.299   ('small-medium' Cohen 1988)
#
#
# Altieri figure 4
# approx effect size, early season: (negative)
# approx effect size, mid season:   approx .5 'medium'
# approx effect size, late season:  approx .2 'small'

pwr::pwr.2p.test(h=0.757, sig.level=0.05, power=0.8)


```



```{r densityPlots, echo=FALSE, include=TRUE, results="hide", message=F, warning=T, out.width=c('50%', '50%'), fig.show='hold' }


combo.period1.tibl <- bugs.tibl %>% 
  filter(time != 'am') %>%
  filter(week < 26)

combo.period2.tibl <- bugs.tibl %>% 
  filter(time != 'am') %>%
  filter(week > 25 & week < 31)

combo.period3.tibl <- bugs.tibl %>% 
  filter(time != 'am') %>%
  filter(week > 30)



input.tibl <- combo.period1.tibl %>% mutate(transect=replace(as.character(transect), transect=='oakMargin', 'SNH')) %>% as_tibble()

densityNoFacets(tibble=input.tibl, periodString="period 1")
densityFacets(tibble=input.tibl, periodString="period 1")

input.tibl <- combo.period2.tibl %>% mutate(transect=replace(as.character(transect), transect=='oakMargin', 'SNH')) %>% as_tibble()

densityNoFacets(tibble=input.tibl, periodString="period 2")
densityFacets(tibble=input.tibl, periodString="period 2")

input.tibl <- combo.period3.tibl %>% mutate(transect=replace(as.character(transect), transect=='oakMargin', 'SNH')) %>% as_tibble()

print( densityNoFacets(tibble=input.tibl, periodString="period 3") )
print( densityFacets(tibble=input.tibl, periodString="period 3") )


```


```{r errorBars, echo=FALSE, include=TRUE, results="hide", message=F, warning=T, out.width=c('50%', '50%'), fig.show='hold'}

# calculate the mean and SE of traps (like Altieri)
# https://stackoverflow.com/questions/2676554/in-r-how-to-find-the-standard-error-of-the-mean
combo1.means.tibl <- combo.period1.tibl %>%
    group_by(transect, positionX) %>%
    summarize(mean = mean(Thomisidae..crab.spider., na.rm=TRUE),
              se = sd(Thomisidae..crab.spider., na.rm=TRUE) /
                    sqrt(length(position)),
              observations = n()
              )

combo2.means.tibl <- combo.period2.tibl %>%
    group_by(transect, positionX) %>%
    summarize(mean = mean(Thomisidae..crab.spider., na.rm=TRUE),
              se = sd(Thomisidae..crab.spider., na.rm=TRUE) /
                    sqrt(length(position)),
              observations = n()
              )

combo3.means.tibl <- combo.period3.tibl %>%
    group_by(transect, positionX) %>%
    summarize(mean = mean(Thomisidae..crab.spider., na.rm=TRUE),
              se = sd(Thomisidae..crab.spider., na.rm=TRUE) /
                    sqrt(length(position)),
              observations = n()
              )

# Two data samples are independent if they come from distinct populations and the samples do not affect each other. Using the Mann-Whitney-Wilcoxon Test, we can decide whether the population distributions are identical without assuming them to follow the normal distribution.
# http://www.r-tutor.com/elementary-statistics/non-parametric-methods/mann-whitney-wilcoxon-test

wilcox.test(mean ~ transect, data=combo1.means.tibl, correct=FALSE)
wilcox.test(mean ~ transect, data=combo2.means.tibl, correct=FALSE)
wilcox.test(mean ~ transect, data=combo3.means.tibl, correct=FALSE)

# ***    'mean' shoud be OK    ***
# 2. If the data represent essentially discrete values (e.g. they
# are count data, or ordered categorical), where ties are intrinsically
# possible, then strictly speaking the Mann-Whitney test is not
# appropriate, since its distribution function depends on the assumption
# of continuity which is not true here.
# https://stat.ethz.ch/pipermail/r-help/2009-December/415767.html

# for more than 2 groups
# http://www.sthda.com/english/wiki/kruskal-wallis-test-in-r


errorBars(tibble=combo1.means.tibl, periodString = "period 1", observations = 27)

errorBars(tibble=combo2.means.tibl, periodString = "period 2", observations = 39)

errorBars(tibble=combo3.means.tibl, periodString = "period 3", observations = 27)



```



```{r bayes, echo=FALSE, include=TRUE, results="hide", message=F, warning=T, out.width=c('50%', '50%'), fig.show='hold'}

setwd("/Users/rcphelps/code/thesis/ampelos")
source('./code/bayes.R')
source('./code/bayesNoClusters.R')

ggsave.path <- "/Users/rcphelps/code/thesis/ampelos/code/output/"
seed <- 101
hypotheticalPopulation <- c(58.13,15.93,6.67)

library("dplyr")


    # rl <- returnList

    # organize data into
    #       "week", "transect", "time", "cluster", "totalSpiders"
    # ( already done by evaluateDailySpiderCounts() )
    #
    # create txt files saving the status output of 9 brm() cycles

    #
    #         existing models will be read from disc
    #         with TRUE/FALSE logic in generateLikelihoodV2() ......
    #
    ##
    ## rl[[4]] is the 4th member of the output of evaluateDailySpiderCounts(bugs.df)
    ## multiple records per week with columns
    ## week, transect, time, cluster, totalSpiders
    ##
    #filtered.df <- rl[[4]] %>% dplyr::filter(time == 'pm')
    
    
    filtered.df <- bugs.tibl %>% 
      filter(time != 'am') %>% 
      rename(totalSpiders = Thomisidae..crab.spider.)
    
    
    # read data from disc with fromDisc=TRUE
    # re-build brm model and posterior distribution with fromDisc=FALSE
    
    # compare predictions for a high contact and low contact vines
    
    gg.likelihood.pm.lst <- list()
    
    gg.likelihood.pm.lst <- generateLikelihoodV3(df=filtered.df,
              daytime='pm', fromDisc=FALSE, path= ggsave.path,
              randomSeed=seed, hp=hypotheticalPopulation)
    
    # just print the plausibility graph
    
    print(gg.likelihood.pm.lst[[1]])
      
    fileName <- paste("ggsave.plausibility.1.v2.pdf", sep="")
  
    if (file.exists(fileName)) { file.remove(fileName) }
      
    ggsave(fileName, 
              plot = gg.likelihood.pm.lst[[1]], 
              device = NULL, path = ggsave.path,
              scale = 1, width = 6, height = NA, dpi = 300, limitsize = TRUE,
              units = c("in", "cm", "mm"))

```

```{r posteriorGraphs, echo=FALSE, include=TRUE, results="hide", message=F, warning=T, out.width=c('50%', '50%'), fig.show='hold'}

# display the posterior graphs 

    for (i in 2:length(gg.likelihood.pm.lst)) {
    
      print(gg.likelihood.pm.lst[[i]])
      
      fileName <- paste("ggsave.plausibility.", i, ".v2.pdf", sep="")
  
      if (file.exists(fileName)) { file.remove(fileName) }
      
      ggsave(fileName, 
              plot = gg.likelihood.pm.lst[[i]], 
              device = NULL, path = ggsave.path,
              scale = 1, width = 6, height = NA, dpi = 300, limitsize = TRUE,
              units = c("in", "cm", "mm"))
      
    }
    

```


```{r modelDiags, echo=FALSE, include=TRUE, results="hide", message=F, warning=T, out.width=c('50%', '50%'), fig.show='hold'}

  source('/Users/rcphelps/code/thesis/ampelos/code/bayesNoCLusters.R')

  daytime <- "pm"
  path <- "/Users/rcphelps/code/thesis/ampelos/code/output/"
  

	fullPath.rds <- paste(path, "listV2-", daytime, ".rds", sep="")

  # read the 3 models from disc and run diags
	gg.lst <- list()
  gg.lst <- modelDiagsV3(daytime='pm', hp=hypotheticalPopulation, rds=fullPath.rds)

  for (i in 1:length(gg.lst)) {
  
    print(gg.lst[[i]])
  
    fileName <- paste("ggsave.poisson.", i, ".4.2.V2.pdf", sep="")
    ggsave.path <- "/Users/rcphelps/code/thesis/ampelos/code/output/"
    fullPath <- paste(ggsave.path, fileName, sep="")
  
    if (file.exists(fullPath)) { file.remove(fullPath) }

    ggsave(fileName, plot = gg.lst[[i]], 
              device = NULL, path = ggsave.path,
              scale = 1, width = 6, height = NA, dpi = 300, limitsize = TRUE,
              units = c("in", "cm", "mm"))
  }


```

