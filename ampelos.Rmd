---
title: "ampelos"
output: github_document
---

![landscape](./photos/landscapeOak.JPG)

## how does a 'natural' field margin influence the population of beneficial insects?


```{r, echo=T, message=F, warning=F}

source("./code/bug-library.R")
source("./code/similarity.R")
source("./code/jaccard-similarity.R")

source.url <- c("https://raw.githubusercontent.com/cordphelps/ampelos/master/data/bugs.csv")
bugs.df <- read.csv(source.url, header=TRUE, row.names=NULL)


```

## is there a difference in the spider populations for the two transects?

```{r, echo=TRUE, include=TRUE, message=F, warning=F}


reducedData.df <- selectDataAcrossTransects(data=bugs.df, week=quo(26), species=quo(Thomisidae..crab.spider.))

g1 <- plotBugDistribution(data=reducedData.df, 
                          title=paste("crab spider occurrences", "\nweek 26", sep=""), 
                          caption="stuff")

reducedData.df <- selectDataAcrossTransects(data=bugs.df, week=quo(30), species=quo(Thomisidae..crab.spider.))

g2 <- plotBugDistribution(data=reducedData.df, 
                          title=paste("crab spider occurrences", "\nweek 30", sep=""), 
                          caption="stuff")

g <- arrangeGrob(g1, g2, nrow=1)

```




```{r, echo=TRUE, include=TRUE, message=F, warning=F}

positionText <- paste("\ntransect positions ", "1-3", sep="")
g3 <- compareTransectUsingQuosure(data=bugs.df, 
                                 species=quo(Thomisidae..crab.spider.), 
                                 operator="LT",
                                 initialPosition=quo(4), 
                                 secondaryPosition=quo(0),
                                 positionText)
positionText <- paste("\ntransect positions ", "4-6", sep="")
g46 <- compareTransectUsingQuosure(data=bugs.df, 
                                 species=quo(Thomisidae..crab.spider.), 
                                 operator="BETWEEN",
                                 initialPosition=quo(3), 
                                 secondaryPosition=quo(7),
                                 positionText)
positionText <- paste("\ntransect positions ", "7-10", sep="")
g7 <- compareTransectUsingQuosure(data=bugs.df, 
                                 species=quo(Thomisidae..crab.spider.), 
                                 operator="GT",
                                 initialPosition=quo(6), 
                                 secondaryPosition=quo(0),
                                 positionText)
g <- arrangeGrob(g3, g46, g7, nrow=3)
newFile <- paste("ampelos-", format(Sys.time(), "%d-%m-%Y-%H%M"), ".pdf", sep = "")
ggsave(file=newFile, g, width=20, height=30, device = "pdf", units = "cm") #saves g


```

## transect design

![transect layout](./images/transectLayout.jpg)

## each of the two transects consists of 3 rows of 10 traps in each row. Is the total insect population relatively uniform among the 3 rows of a transect? Does this uniformity change over time? Compute the Jaccard Index for each week: the index *'is a statistic used for comparing the similarity and diversity of sample sets.'* 

### Note that *'the Jaccard index only counts mutual presence as matches and compares it to the number of attributes that have been chosen by at least one of the two sets.'* (https://en.wikipedia.org/wiki/Jaccard_index)

### TO-DO: compare Jaccard to the Simple Matching Coefficient (which also counts mutual absence): https://en.wikipedia.org/wiki/Simple_matching_coefficient

```{r, echo=TRUE, include=TRUE, message=F, warning=F }

gOak <- compareJaccardMultiWeekV3(data=bugs.df, 
                                  transect=quo("oakMargin"),
                                  transectText="oakMargin")
gControl <- compareJaccardMultiWeekV3(data=bugs.df, 
                                      transect=quo("control"),
                                      transectText="control")

g <- arrangeGrob(gOak, gControl, nrow=2)

```

## how about the insect populations themselves? Is the presence of any particular species correlated with the presence of a different species?

```{r, echo=TRUE, include=TRUE, message=F, warning=F }

m1 <- simMatrixV2(data=bugs.df, transect=quo("oakMargin"),
                                transectText="oakMargin")
m2 <- simMatrixV2(data=bugs.df, transect=quo("control"),
                                transectText="control")

g <- arrangeGrob(m1, m2, nrow=2)
```

## does the crab spider population appear to change over time? Is there a difference between the two transects?

```{r, echo=TRUE, include=TRUE, message=F, warning=F}

# pass variables to dyplr pipes
# https://stackoverflow.com/questions/27975124/pass-arguments-to-dplyr-functions
plotSpeciesTrend(data=bugs.df, bugs=quo(Thomisidae..crab.spider.), speciesText="Crab Spider", where="control", when="pm", caption=Sys.Date())

```

## the crab spider is a dominant species in the vineyard. How are they distributed along the length of the row? 

```{r}
plotRidges(data=bugs.df, combined=FALSE, bugs="Thomisidae..crab.spider.", speciesText="Crab Spider", where="control", when="pm", wk=1, caption=Sys.Date())

new.df <- bugs.df %>% mutate(newColumn = ifelse(Thomisidae..crab.spider. > 0, 1, 0))
plotRidges(data=new.df, combined=TRUE, bugs="newColumn", speciesText="Crab Spider", where="control", when="pm", wk=1, caption=Sys.Date())
plotRidges(data=new.df, combined=TRUE, bugs="newColumn", speciesText="Crab Spider", where="oakMargin", when="pm", wk=1, caption=Sys.Date())
```

## and the species counts?

```{r kable, results='asis', echo=FALSE, message=F, warning=F}

bugList <- colnames(bugs.df[,5:22])
trim.tbl <- bugs.df %>% select(5:22) %>% colSums() %>% t()
# https://stackoverflow.com/questions/9623763/in-r-how-can-i-compute-percentage-statistics-on-a-column-in-a-dataframe-tabl
#trim.tbl <- table(trim.df)
trim.tbl <- t(trim.tbl)
trim.tbl <- cbind(trim.tbl,round(prop.table(trim.tbl)*100,2))
colnames(trim.tbl) <- c('count','percentage')

knitr::kable(trim.tbl)


```



## bottom of the Oak Transect; bird repellant streamers indicating the prevailing wind direction

![landscape](./photos/windDirection.JPG)

## top of the Control Transect

![landscape](./photos/topOfControl.JPG)

## bottom of the Control Transect with bird repellant streamers 

![landscape](./photos/bottomOfControl.JPG)

## typical trap positioning; bowl in the fruit zone, vanes intersecting the canopy

![landscape](./photos/typicalTrap.JPG)

## example trap sequence

![landscape](./photos/trapSequence.JPG)




